<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solicitud de Viaje</title>
</head>
<body>
  <h1>Formulario de Solicitud de Viaje</h1>
  <form id="travel-form">
    <label for="rut">RUT (sin puntos ni guion):</label>
    <input type="text" id="rut" required /><br><br>

    <label for="clave">Clave Personal:</label>
    <input type="text" id="clave" required /><br><br>

    <label for="nombre">Nombre del pasajero:</label>
    <input type="text" id="nombre" readonly /><br><br>

    <label for="fecha">Fecha del viaje:</label>
    <input type="date" id="fecha" required /><br><br>

    <label for="hora">Hora (24 horas):</label>
    <input type="time" id="hora" required /><br><br>

    <label for="origen">Origen del viaje:</label>
    <input type="text" id="origen" required /><br><br>

    <label for="destino">Destino del viaje:</label>
    <input type="text" id="destino" required /><br><br>

    <label for="conductor">Selecciona conductor:</label>
    <select id="conductor" required>
      <option value="">-- Elige un conductor --</option>
      <option value="https://wa.me/56912345678">Juan Pérez</option>
      <option value="https://wa.me/56987654321">María González</option>
    </select><br><br>

    <button type="submit">Solicitar Viaje</button>
  </form>

  <script>
    const pasajeros = [
      { rut: "111111111", clave: "ClaveA", nombre: "Ana Torres" },
      { rut: "222222222", clave: "ClaveB", nombre: "Carlos Muñoz" },
      { rut: "333333333", clave: "ClaveC", nombre: "Josefa Rojas" }
    ];

    const rutInput = document.getElementById('rut');
    const claveInput = document.getElementById('clave');
    const nombreInput = document.getElementById('nombre');
    const form = document.getElementById('travel-form');

    let pasajeroActual = null;

    function validarRut(rut) {
      if (!/^\d{7,8}[0-9kK]?$/.test(rut)) return false;

      let cuerpo = rut.slice(0, -1);
      let dv = rut.slice(-1).toLowerCase();

      let suma = 0;
      let multiplo = 2;

      for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo[i]) * multiplo;
        multiplo = multiplo < 7 ? multiplo + 1 : 2;
      }

      let dvEsperado = 11 - (suma % 11);
      dvEsperado = dvEsperado === 11 ? "0" : dvEsperado === 10 ? "k" : dvEsperado.toString();

      return dv === dvEsperado;
    }

    rutInput.addEventListener('blur', () => {
      const rut = rutInput.value.trim();
      if (!validarRut(rut)) {
        alert("RUT inválido. Debe ingresarlo sin puntos ni guion, pero con dígito verificador.");
        rutInput.value = '';
        rutInput.focus();
        pasajeroActual = null;
        return;
      }
    });

    claveInput.addEventListener('blur', () => {
      const rut = rutInput.value.trim();
      const clave = claveInput.value.trim();

      const encontrado = pasajeros.find(p => p.rut === rut && p.clave === clave);
      if (encontrado) {
        nombreInput.value = encontrado.nombre;
        pasajeroActual = encontrado;
      } else {
        alert("RUT o Clave Personal incorrectos.");
        claveInput.value = '';
        nombreInput.value = '';
        pasajeroActual = null;
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!pasajeroActual) {
        alert("Debe ingresar correctamente el RUT y la Clave Personal antes de continuar.");
        return;
      }

      const fecha = document.getElementById('fecha').value;
      const hora = document.getElementById('hora').value;
      const origen = document.getElementById('origen').value;
      const destino = document.getElementById('destino').value;
      const conductorLink = document.getElementById('conductor').value;

      if (!conductorLink) {
        alert("Debe seleccionar un conductor.");
        return;
      }

      const mensaje = `Nueva solicitud de viaje:\n\n` +
                      `Nombre del pasajero: ${pasajeroActual.nombre}\n` +
                      `RUT: ${pasajeroActual.rut}\n` +
                      `Fecha: ${fecha}\n` +
                      `Hora: ${hora}\n` +
                      `Origen: ${origen}\n` +
                      `Destino: ${destino}`;

      const url = `${conductorLink}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    });
  </script>
</body>
</html>
